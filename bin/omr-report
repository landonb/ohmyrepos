#!/usr/bin/env bash
# vim:tw=0:ts=2:sw=2:et:norl:ft=bash
# Author: Landon Bouma (landonb &#x40; retrosoft &#x2E; com)
# Project: https://github.com/landonb/ohmyrepos#üò§
# License: MIT

# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ #

__USAGE__='
  path/to/omr-report [<base-dir> ...] [<prune-dir> -prune ...]

  E.g.,

    $ omr-report "${HOME}" "/opt/work" "${HOME}/.gopath" -prune "/opt/work/ignore" -prune
'

# These environs are also effective, but rarely used.
OMR_PROGGER=${OMR_PROGGER:-true}
OMR_TRACE_CMD=${OMR_TRACE_CMD:-false}
OMR_VERBOSE=${OMR_VERBOSE:-false}

# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ #

_omr_report_source_deps () {
  # Load: cache_termimal_width, clear_line, omr_is_registered,
  #       _vendorfs_path_stints_basedir_print
  # CXREF: ~/.kit/git/ohmyrepos/bin/omr-is-registered
  . "$(dirname -- "$(realpath -- "${BASH_SOURCE[0]}")")/omr-is-registered"
}

# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ #

omr_report () {
  local start_dirs=()
  local prune_dirs=()

  while [ "$1" != '' ]; do
    if [ "$2" = '-prune' ]; then
      prune_dirs+=("$1")
      shift 2
    else
      start_dirs+=("$1")
      shift
    fi
  done

  if [ ${#start_dirs[@]} -eq 0 ]; then
    start_dirs+=("${HOME}")
  fi

  # ***

  local prune_opts=""

  for ((ix = 0; ix < ${#prune_dirs[@]}; ix++)); do
    prune_dir="${prune_dirs[$ix]}"

    if [ -n "${prune_opts}" ]; then
      prune_opts="${prune_opts} -o "
    fi
    prune_opts="${prune_opts}-path \"${prune_dir}\""
  done

  if [ -n "${prune_opts}" ]; then
    prune_opts="\( ${prune_opts} \) -prune -o"
  fi

  # ***

  local REG_CNT=0
  local SKP_CNT=0
  local UNK_CNT=0

  for ((ix = 0; ix < ${#start_dirs[@]}; ix++)); do
    base_dir="${start_dirs[$ix]}"

    scan_for_projects "${base_dir}" "${prune_opts}"

    clear_line
  done

  echo "Number of registered OMR projects: ${REG_CNT} (${SKP_CNT} skipped)"

  if [ ${UNK_CNT} -ne 0 ]; then
    # But is it, though?
    #
    #  >&2 echo "ERROR: OMR missing this many gits: ${UNK_CNT}"
    #
    #  return 1
    echo "- Number of unregistered projects: ${UNK_CNT}"
  fi
}

# ***

scan_for_projects () {
  local base_dir="$1"
  local prune_opts="$2"

  clear_line

  echo "base_dir: ${base_dir}"

  local cmd_find_git_projs
  cmd_find_git_projs="$(print_cmd_find_git_projs "${base_dir}" "${prune_opts}")"

  trace_cmd "${cmd_find_git_projs}"

  # ***

  local dot_cnt=0

  local progger_set="${SPINNER_SEQUENCE:-‚ñè‚ñé‚ñç‚ñå‚ñã‚ñä‚ñâ‚ñä‚ñã‚ñå‚ñç‚ñé}"
  local progger_width=${SPINNER_ONEWIDTH:-1}
  local progger_len=${#progger_set}
  local progger_curr=0

  # ***

  while read proj_dir; do
    local TERM_WIDTH=0
    cache_termimal_width

    local reg_code=0
    omr_is_registered "${proj_dir}" \
      || reg_code=$?

    if [ ${reg_code} -eq 1 ]; then
      let "UNK_CNT += 1"
      dot_cnt=0
    else
      if [ ${reg_code} -eq 0 ]; then
        let "REG_CNT += 1"
      elif [ ${reg_code} -eq 99 ]; then
        let "SKP_CNT += 1"
      fi

      if ! ${OMR_VERBOSE:-false} \
        && ${OMR_PROGGER:-true} \
        && stdout_isatty \
        && [ ${TERM_WIDTH} -gt 0 ] \
      ; then
        local progger_char=${progger_set:${progger_curr}:${progger_width}}

        printf "${progger_char}"

        let "dot_cnt += ${progger_width}"
      fi

      progger_curr=$(((${progger_curr} + ${progger_width}) % ${progger_len}))
    fi

    if [ ${dot_cnt} -gt $((${TERM_WIDTH} / 2)) ]; then
      clear_line
      dot_cnt=0
    fi
  done < <(eval "${cmd_find_git_projs}");
}

# ***

# E.g.,
#   find \
#     "${HOME}/" \
#     \( \
#       -name "TBD-*" -o -name "*-TBD" \
#       -o -path "${HOME}/Downloads" \
#       -o -path "${HOME}/.gopath" \
#       -o -path "${HOME}/.trash*" \
#     \) -prune -o \
#     -type d \
#     -name ".git" \
#     -print

print_cmd_find_git_projs () {
  local base_dir="$1"
  local prune_opts="$2"

  echo "find \\
    \"${base_dir}/\" \\
    ${prune_opts} \\
    -type d \\
    -name \".git\" \\
    -print \\
    | xargs dirname \\
    | sort"
}

trace_cmd () {
  local the_cmd="$1"

  if ! ${OMR_TRACE_CMD:-false}; then
    return 0
  fi

  echo "${the_cmd}"
}

# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ #

main () {
  set -e

  # Load: set_traps, clear_traps, exit_0, exit_1, os_is_macos.
  . "$(dirname -- "$(realpath -- "$0")")/../deps/sh-err-trap/lib/err-trap.sh"

  set_traps

  _omr_report_source_deps

  # ***

  omr_report "$@"

  # ***

  clear_traps
}

if [ "$0" = "${BASH_SOURCE[0]}" ]; then
  main "$@"
fi

